<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Application</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .question-group {
            display: none;
        }

        .question-group.active {
            display: block;
        }

        .timer {
            font-size: 1.2em;
            font-weight: bold;
        }

        .progress {
            height: 25px;
        }

        .media-content {
            max-width: 100%;
            margin: 15px 0;
        }

        .media-content img {
            max-width: 100%;
        }

        .media-content iframe {
            max-width: 100%;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <!-- Login Form -->
        <div id="loginForm">
            <h2 class="text-center mb-4">Login</h2>
            <div class="card p-4">
                <div class="mb-3">
                    <label for="username" class="form-label">Nom d'utilisateur</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label for="usercode" class="form-label">Code d'accès</label>
                    <input type="password" class="form-control" id="usercode" required>
                </div>
                <div class="mb-3">
                    <label for="quizcode" class="form-label">Code du quiz</label>
                    <input type="text" class="form-control" id="quizcode" required>
                </div>
                <button class="btn btn-primary" onclick="startQuiz()">Commencer le Quiz</button>
            </div>
        </div>

        <!-- Quiz Container -->
        <div id="quizContainer" style="display: none;">
            <h1 id="quizTitle" class="text-center mb-4"></h1>

            <!-- Timer and Progress -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="timer">Temps restant: <span id="timer">--:--</span></div>
                </div>
                <div class="col-md-6">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;">
                            <span id="progressText">Question 0/0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Questions -->
            <div id="questionsContainer"></div>

            <!-- Navigation -->
            <div class="d-flex justify-content-between mt-4">
                <button id="prevBtn" class="btn btn-secondary" onclick="showPreviousQuestion()">Précédent</button>
                <button id="nextBtn" class="btn btn-primary" onclick="showNextQuestion()">Suivant</button>
                <button id="submitBtn" class="btn btn-success" style="display: none;"
                    onclick="submitQuiz()">Terminer</button>
            </div>
        </div>

        <!-- Results Container -->
        <div id="resultsContainer" style="display: none;">
            <h2 class="text-center mb-4">Résultats</h2>
            <div class="card p-4">
                <h3 class="text-center">Note finale: <span id="finalScore">0</span>/100</h3>
                <div id="detailedResults"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

    <script>
        // Fonction pour charger un script de manière asynchrone
        function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        // Configuration globale
        const dataBaseUrl = 'https://raw.githubusercontent.com/abcquiz/choices/refs/heads/main/examples';
        const usercodes = ['CODE123', 'ADMIN456', 'TEST789']; // Codes d'accès autorisés

        let quizConfig = null;
        let questions = null;
        let currentGroupIndex = 0;
        let questionGroups = [];
        let userAnswers = {};
        let quizTimer = null;
        let questionTimer = null;

        // Fonction de démarrage du quiz
        async function startQuiz() {
            const username = $('#username').val();
            const usercode = $('#usercode').val();
            const quizcode = $('#quizcode').val();

            if (!username || !usercode || !quizcode) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            if (!usercodes.includes(usercode)) {
                alert('Code d\'accès invalide');
                return;
            }

            try {
                // On charge d'abord les scripts
                await loadScript(`${dataBaseUrl}/${quizcode}/config.js`);
                await loadScript(`${dataBaseUrl}/${quizcode}/questions.js`);

                // Maintenant on peut accéder aux variables globales
                quizConfig = config;
                questions = window.questions;

                // Organisation des questions en groupes
                organizeQuestionGroups();

                // Initialisation de l'interface
                initializeQuizInterface();

                // Démarrage du chrono global
                startGlobalTimer();
            } catch (error) {
                alert('Erreur lors du chargement du quiz. Veuillez vérifier le code du quiz.');
                console.error(error);
            }
        }

        // Organisation des questions en groupes
        function organizeQuestionGroups() {
            questionGroups = [];
            let currentGroup = [];

            questions.forEach(question => {
                if (!question.groupId && currentGroup.length > 0) {
                    questionGroups.push(currentGroup);
                    currentGroup = [question];
                } else if (!question.groupId) {
                    questionGroups.push([question]);
                } else {
                    if (currentGroup.length > 0 && currentGroup[0].groupId !== question.groupId) {
                        questionGroups.push(currentGroup);
                        currentGroup = [question];
                    } else {
                        currentGroup.push(question);
                    }
                }
            });

            if (currentGroup.length > 0) {
                questionGroups.push(currentGroup);
            }
        }

        // Initialisation de l'interface du quiz
        function initializeQuizInterface() {
            $('#loginForm').hide();
            $('#quizContainer').show();
            $('#quizTitle').text(quizConfig.title);

            displayCurrentQuestionGroup();
            updateProgress();
        }

        // Affichage du groupe de questions actuel
        function displayCurrentQuestionGroup() {
            const currentGroup = questionGroups[currentGroupIndex];
            const container = $('#questionsContainer');
            container.empty();

            currentGroup.forEach((question, index) => {
                const questionHtml = createQuestionHtml(question, index);
                container.append(questionHtml);

                if (question.timer) {
                    startQuestionTimer(question.timer, index);
                }
            });

            updateNavigationButtons();
        }

        // Création du HTML pour une question
        function createQuestionHtml(question, index) {
            let mediaHtml = '';
            if (question.content.type === 'image') {
                mediaHtml = `<img src="${question.content.url}" alt="Question media" class="media-content">`;
            } else if (question.content.type === 'video') {
                mediaHtml = `<iframe width="560" height="315" src="${question.content.url}" frameborder="0" allowfullscreen class="media-content"></iframe>`;
            } else if (question.content.type === 'audio') {
                mediaHtml = `<audio controls src="${question.content.url}" class="media-content"></audio>`;
            }

            let choicesHtml = question.choices.map((choice, choiceIndex) => `
                <div class="form-check">
                    <input class="form-check-input" type="${question.choices.length > 1 ? 'checkbox' : 'radio'}"
                           name="question${index}" value="${choiceIndex}" id="choice${index}_${choiceIndex}">
                    <label class="form-check-label" for="choice${index}_${choiceIndex}">
                        ${choice.text}
                    </label>
                </div>
            `).join('');

            return `
                <div class="card mb-4 question" data-question-index="${index}">
                    <div class="card-body">
                        <h5 class="card-title">Question ${index + 1}</h5>
                        <p class="card-text">${question.content.text}</p>
                        ${mediaHtml}
                        <div class="choices mt-3">
                            ${choicesHtml}
                        </div>
                        ${question.timer ? `<div class="question-timer mt-2">Temps restant: <span id="questionTimer${index}">--:--</span></div>` : ''}
                    </div>
                </div>
            `;
        }

        // Mise à jour des boutons de navigation
        function updateNavigationButtons() {
            $('#prevBtn').toggle(currentGroupIndex > 0);
            $('#nextBtn').toggle(currentGroupIndex < questionGroups.length - 1);
            $('#submitBtn').toggle(currentGroupIndex === questionGroups.length - 1);
        }

        // Mise à jour de la barre de progression
        function updateProgress() {
            const progress = ((currentGroupIndex + 1) / questionGroups.length) * 100;
            $('#progressBar').css('width', `${progress}%`);
            $('#progressText').text(`Question ${currentGroupIndex + 1}/${questionGroups.length}`);
        }

        // Démarrage du chrono global
        function startGlobalTimer() {
            let timeLeft = quizConfig.duration;

            function updateTimer() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                $('#timer').text(`${minutes}:${seconds.toString().padStart(2, '0')}`);

                if (timeLeft === 0) {
                    clearInterval(quizTimer);
                    submitQuiz();
                }
                timeLeft--;
            }

            updateTimer();
            quizTimer = setInterval(updateTimer, 1000);
        }

        // Démarrage du chrono pour une question
        function startQuestionTimer(duration, questionIndex) {
            let timeLeft = duration;

            function updateTimer() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                $(`#questionTimer${questionIndex}`).text(`${minutes}:${seconds.toString().padStart(2, '0')}`);

                if (timeLeft === 0) {
                    clearInterval(questionTimer);
                    $(`input[name="question${questionIndex}"]`).prop('disabled', true);
                }
                timeLeft--;
            }

            updateTimer();
            questionTimer = setInterval(updateTimer, 1000);
        }

        // Navigation entre les groupes de questions
        function showPreviousQuestion() {
            if (currentGroupIndex > 0) {
                currentGroupIndex--;
                displayCurrentQuestionGroup();
                updateProgress();
            }
        }

        function showNextQuestion() {
            if (currentGroupIndex < questionGroups.length - 1) {
                currentGroupIndex++;
                displayCurrentQuestionGroup();
                updateProgress();
            }
        }

        // Soumission du quiz
        function submitQuiz() {
            clearInterval(quizTimer);
            if (questionTimer) clearInterval(questionTimer);

            // Calcul du score
            let totalScore = 0;
            const detailedResults = [];

            questionGroups.forEach(group => {
                group.forEach((question, index) => {
                    const selectedAnswers = $(`input[name="question${index}"]:checked`).map(function () {
                        return parseInt($(this).val());
                    }).get();

                    const score = calculateQuestionScore(question, selectedAnswers);
                    totalScore += score;

                    if (quizConfig.showAnswers) {
                        detailedResults.push({
                            question: question.content.text,
                            score: score,
                            correctAnswers: question.choices.filter(choice => choice.correct).map(choice => choice.text),
                            selectedAnswers: selectedAnswers.map(idx => question.choices[idx].text)
                        });
                    }
                });
            });

            displayResults(totalScore, detailedResults);
        }

        // Calcul du score pour une question
        function calculateQuestionScore(question, selectedAnswers) {
            const correctAnswers = question.choices.map((choice, index) => ({ index, correct: choice.correct }))
                .filter(choice => choice.correct)
                .map(choice => choice.index);

            const n = correctAnswers.length;
            let score = 0;

            selectedAnswers.forEach(answer => {
                if (correctAnswers.includes(answer)) {
                    score += 1 / n;
                } else {
                    score -= 1 / n;
                }
            });

            return Math.max(0, Math.min(1, score));
        }

        // Affichage des résultats
        function displayResults(totalScore, detailedResults) {
            $('#quizContainer').hide();
            $('#resultsContainer').show();

            const finalScore = (totalScore / questions.length * 100).toFixed(2);
            $('#finalScore').text(finalScore);

            if (quizConfig.showAnswers) {
                const detailedHtml = detailedResults.map(result => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">${result.question}</h6>
                            <p>Score: ${(result.score * 100).toFixed(2)}%</p>
                            <p>Réponses correctes: ${result.correctAnswers.join(', ')}</p>
                            <p>Vos réponses: ${result.selectedAnswers.join(', ')}</p>
                        </div>
                    </div>
                `).join('');

                $('#detailedResults').html(detailedHtml);
            }
        }
    </script>
</body>

</html>