{
    # Configuration globale
    admin off
    auto_https off # Désactive la gestion automatique HTTPS pour localhost
}

(common) {
    root * /usr/share/caddy
    encode gzip
    file_server

    # Headers de sécurité communs avec permissions de stockage
    header {
        Access-Control-Allow-Origin *
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
        Access-Control-Expose-Headers "Content-Length,Content-Range"
        # Headers critiques pour le stockage local
        Cross-Origin-Opener-Policy "same-origin"
        Cross-Origin-Embedder-Policy "require-corp"
        Cross-Origin-Resource-Policy "cross-origin"
        # Sécurité générale
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "no-referrer-when-downgrade"
        Permissions-Policy "interest-cohort=(),storage-access=*,clipboard-write=*"
    }
}

# Configuration pour localhost (HTTP)
:80 {
    import common
}

# Configuration pour le domaine en production (si nécessaire)
{$DOMAIN} {
    import common
    tls {
        protocols tls1.2 tls1.3
    }
}